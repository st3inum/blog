<!DOCTYPE html>
<html>
<head>
    <title>Encoded Spoiler Test</title>
    <style>
        /* Base spoiler styles */
        .spoiler {
            margin: 1em 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        /* Spoiler block container */
        .spoiler_block {
            padding: 0;
            margin: 0;
        }

        /* Spoiler content */
        .spoiler_block_content {
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        /* Spoiler toggle links */
        .spoiler_block_show,
        .spoiler_block_hide {
            display: block;
            padding: 10px 15px;
            background-color: #f5f5f5;
            cursor: pointer;
            text-decoration: none;
            color: #333;
            font-weight: normal;
        }

        /* Make sure links inside the title don't look like links */
        .spoiler_block_show a,
        .spoiler_block_hide a {
            color: inherit;
            text-decoration: inherit;
        }

        /* Hover effect */
        .spoiler_block_show:hover,
        .spoiler_block_hide:hover {
            background-color: #ebebeb;
        }

        /* Icons for show/hide */
        .spoiler-block-icon-zoom-in::before {
            content: "+ ";
            font-weight: bold;
        }

        .spoiler-block-icon-zoom-out::before {
            content: "- ";
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Encoded Spoiler Test</h1>
    
    <!-- Test with encoded title and content -->
    <div class="hugo-spoiler" 
        data-spoiler-title="%3Cb%3EConstraints%3C%2Fb%3E" 
        data-spoiler-content="%3Cul%3E%0A%3Cli%3E%24A_%7Bi%7D%20%5Cle%202%5E%7B60%7D%24%3C%2Fli%3E%0A%3Cli%3E%24n%5Cle%2010%5E%7B5%7D%24%3C%2Fli%3E%0A%3Cli%3E%24q%5Cle%2010%5E%7B5%7D%24%3C%2Fli%3E%0A%3Cli%3E%24x%20%5Cle%202%5E%7B60%7D%24%3C%2Fli%3E%0A%3C%2Ful%3E" 
        data-spoiler-type="titled"></div>

    <!-- Test with simple spoiler -->
    <div class="hugo-spoiler" 
        data-spoiler-title="click%20to%20show" 
        data-spoiler-content="This%20is%20a%20simple%20spoiler%20with%20%3Cb%3Ebold%20text%3C%2Fb%3E%20and%20%3Ci%3Eitalic%20text%3C%2Fi%3E." 
        data-spoiler-type="simple"></div>

    <script>
        /**
         * Process spoiler shortcodes and convert them to interactive elements
         */
        function processSpoilerShortcodes() {
            // Process Hugo spoilers with encoded data attributes
            const hugoSpoilers = document.querySelectorAll('.hugo-spoiler');
            console.log(`Found ${hugoSpoilers.length} Hugo spoiler elements`);
            
            hugoSpoilers.forEach((spoiler, index) => {
                const spoilerElement = spoiler;
                
                // Skip if this spoiler has already been processed
                if (spoilerElement.classList.contains('spoiler-processed')) {
                    return;
                }
                
                // Mark as processed
                spoilerElement.classList.add('spoiler-processed');
                
                // Get encoded data attributes and decode them
                const encodedTitle = spoilerElement.getAttribute('data-spoiler-title') || '';
                const encodedContent = spoilerElement.getAttribute('data-spoiler-content') || '';
                const spoilerType = spoilerElement.getAttribute('data-spoiler-type');
                
                // Decode the title and content
                const title = decodeURIComponent(encodedTitle);
                const content = decodeURIComponent(encodedContent);
                
                console.log(`Processing Hugo spoiler ${index} of type ${spoilerType} with title: ${title}`);
                
                // Create the Hugo-style spoiler structure
                const spoilerDiv = document.createElement('div');
                spoilerDiv.className = 'spoiler panel panel-default';
                
                const spoilerBlock = document.createElement('div');
                spoilerBlock.className = 'spoiler_block';
                
                // Show link (initially visible) - use innerHTML to preserve HTML in title
                const showLink = document.createElement('a');
                showLink.href = '#';
                showLink.className = 'spoiler-block-icon spoiler-block-icon-zoom-in spoiler_block_show';
                showLink.innerHTML = title; // Use innerHTML to preserve HTML formatting
                
                // Hide link (initially hidden)
                const hideLink = document.createElement('a');
                hideLink.href = '#';
                hideLink.className = 'spoiler-block-icon spoiler-block-icon-zoom-out spoiler_block_hide';
                hideLink.style.display = 'none';
                hideLink.textContent = 'click to hide';
                
                // Content div (initially hidden)
                const contentDiv = document.createElement('div');
                contentDiv.className = 'spoiler_block_content';
                contentDiv.style.display = 'none';
                contentDiv.innerHTML = content; // Content already has HTML formatting
                
                // Assemble the spoiler structure
                spoilerBlock.appendChild(showLink);
                spoilerBlock.appendChild(hideLink);
                spoilerBlock.appendChild(contentDiv);
                spoilerDiv.appendChild(spoilerBlock);
                
                // Replace the original element with our Hugo-style spoiler
                spoilerElement.parentNode?.replaceChild(spoilerDiv, spoilerElement);
            });
        }

        /**
         * Set up click handlers for spoiler blocks (Hugo style)
         */
        function setupSpoilerClickHandlers() {
            // Define selectors for show/hide links and content
            const switchesSelector = '.spoiler_block_show,.spoiler_block_hide';
            const contentSelector = '.spoiler_block_content';
            
            // Add click event listeners to all spoiler switches
            document.addEventListener('click', (event) => {
                const target = event.target;
                
                // Check if the clicked element is a spoiler switch or a child of a spoiler switch
                const clickedSwitch = target.matches(switchesSelector) ? 
                    target : target.closest(switchesSelector);
                
                if (clickedSwitch) {
                    event.preventDefault();
                    
                    // Find the parent spoiler block
                    const spoilerBlock = clickedSwitch.closest('.spoiler_block');
                    if (spoilerBlock) {
                        // Toggle visibility of show/hide links and content
                        const showHideLinks = spoilerBlock.querySelectorAll(switchesSelector);
                        const contentDivs = spoilerBlock.querySelectorAll(contentSelector);
                        
                        showHideLinks.forEach(link => {
                            link.style.display = 
                                link.style.display === 'none' ? 'block' : 'none';
                        });
                        
                        contentDivs.forEach(div => {
                            div.style.display = 
                                div.style.display === 'none' ? 'block' : 'none';
                        });
                    }
                }
            });
        }

        // Initialize spoilers when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            processSpoilerShortcodes();
            setupSpoilerClickHandlers();
        });
    </script>
</body>
</html>
